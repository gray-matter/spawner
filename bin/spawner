#! /usr/bin/env ruby

$LOAD_PATH.unshift("#{File.dirname(__FILE__)}/../lib")

require 'spawner'

ALLOWED_COMMANDS = ['start']

def usage()
  $stderr.puts "Usage: #$0 #{ALLOWED_COMMANDS.join('/')}"
end

if ARGV.size() != 1 || !ALLOWED_COMMANDS.include?(ARGV[0])
  usage()
  exit 1
end

# TODO:
# - daemonize
# - make it reachable via DrB (to reload, add duty...)
conductor = Spawner::Conductor.new("#{File.dirname(__FILE__)}/../etc/config.yml")

# 20.times() do |i|
#   conductor.add_duty(Proc.new() {puts "Toto #{i}"; sleep 5}, 0)
#   sleep 1
# end

20.times() do |i|
  conductor.add_duty(Proc.new() {puts "Toto #{i}"; sleep 5}, 0)
end

conductor.join() {|ass, unass| puts "Still #{ass} jobs running, #{unass} jobs in the queue"}
